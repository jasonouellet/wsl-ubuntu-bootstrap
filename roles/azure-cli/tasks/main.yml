---
# ==========================================
# Azure CLI Installation - Main Orchestrator
# ==========================================
# This role installs Azure CLI using different methods
# depending on the Linux distribution:
#
# - Debian 13 (Trixie): pip installation (Microsoft recommended)
# - Debian 12 (Bookworm) & Ubuntu: Microsoft APT repository
#
# Reference: https://learn.microsoft.com/en-us/cli/azure/install-azure-cli-linux

- name: Get distribution codename
  ansible.builtin.command: lsb_release -cs
  register: azure_cli_distro_codename_result
  changed_when: false
  check_mode: false
  tags:
    - azure-cli
    - always

- name: Detect distribution version
  ansible.builtin.set_fact:
    azure_cli_is_debian_13: "{{ ansible_facts['distribution'] == 'Debian' and ansible_facts['lsb']['major_release'] == '13' }}"
    azure_cli_is_debian_12: "{{ ansible_facts['distribution'] == 'Debian' and ansible_facts['lsb']['major_release'] == '12' }}"
  tags:
    - azure-cli
    - always

# ==========================================
# Installation Methods by Distribution
# ==========================================
- name: Install Azure CLI for Debian 13 (pip method)
  ansible.builtin.include_tasks: install-pip.yml
  when: azure_cli_is_debian_13
  tags:
    - azure-cli
    - packages

- name: Install Azure CLI for Debian 12/Ubuntu (APT repository)
  ansible.builtin.include_tasks: install-apt-repo.yml
  when: not azure_cli_is_debian_13
  tags:
    - azure-cli
    - packages

# ==========================================
# Verification (all distributions)
# ==========================================
- name: Verify Azure CLI installation
  ansible.builtin.command: az version
  register: az_version
  changed_when: false
  environment:
    PATH: "/home/{{ ansible_user_id }}/.local/bin:/usr/local/bin:{{ ansible_env.PATH }}"
  tags:
    - azure-cli
    - test

- name: Display Azure CLI version
  ansible.builtin.debug:
    msg: "{{ az_version.stdout }}"
  tags:
    - azure-cli
    - test

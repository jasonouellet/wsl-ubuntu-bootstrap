---
- name: Check if CA certificate is provided
  ansible.builtin.set_fact:
    ca_cert_provided: "{{ ssl_ca_cert_name is defined and ssl_ca_cert_name != '' }}"
  tags:
    - ssl-config
    - certificates
    - ssl-verify

- name: Display certificate info
  ansible.builtin.debug:
    msg: "Installing CA certificate: {{ ssl_ca_cert_name }}"
  when: ca_cert_provided
  tags:
    - ssl-config
    - certificates

- name: Display skipping message
  ansible.builtin.debug:
    msg: "No CA certificate configured (ssl_ca_cert_name is empty). Skipping certificate installation."
  when: not ca_cert_provided
  tags:
    - ssl-config
    - certificates

- name: Check if certificate file exists
  ansible.builtin.stat:
    path: "{{ ssl_ca_cert_name }}"
  register: cert_file_stat
  when: ca_cert_provided
  tags:
    - ssl-config
    - certificates

- name: Fail if certificate file not found
  ansible.builtin.fail:
    msg: "CA certificate file '{{ ssl_ca_cert_name }}' not found in the playbook directory"
  when: ca_cert_provided and not cert_file_stat.stat.exists
  tags:
    - ssl-config
    - certificates

- name: Create CA certificate directory
  ansible.builtin.file:
    path: "{{ ssl_ca_cert_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: ca_cert_provided
  tags:
    - ssl-config
    - certificates

- name: Install IA CA certificate
  ansible.builtin.copy:
    src: "{{ ssl_ca_cert_name }}"
    dest: "{{ ssl_ca_cert_full_path }}"
    owner: root
    group: root
    mode: '0644'
  notify: Update CA certificates
  when: ca_cert_provided
  tags:
    - ssl-config
    - certificates

- name: Fix SSL handshake for OpenSSL v3.0.2 - Remove legacy options
  ansible.builtin.replace:
    path: "{{ ssl_openssl_config_path }}"
    after: '^\[system_default_sect\]'
    before: '^\['
    regexp: '^\s*Options\s*=.*$'
    replace: ''
  when: ca_cert_provided
  tags:
    - ssl-config
    - certificates

- name: Fix SSL handshake for OpenSSL v3.0.2 - Add UnsafeLegacyRenegotiation
  ansible.builtin.lineinfile:
    path: "{{ ssl_openssl_config_path }}"
    insertafter: '^\[system_default_sect\]'
    line: 'Options = UnsafeLegacyRenegotiation'
  when: ca_cert_provided
  tags:
    - ssl-config
    - certificates

- name: Verify OpenSSL configuration
  ansible.builtin.command: openssl version
  register: openssl_version
  changed_when: false
  tags:
    - ssl-config
    - test

- name: Display OpenSSL version
  ansible.builtin.debug:
    msg: "OpenSSL version: {{ openssl_version.stdout }}"
  tags:
    - ssl-config
    - test

- name: Verify CA certificate installation
  ansible.builtin.stat:
    path: "{{ ssl_ca_cert_full_path }}"
  register: installed_cert
  when: ca_cert_provided
  tags:
    - ssl-config
    - test

- name: Display certificate installation status
  ansible.builtin.debug:
    msg: "CA certificate installed: {{ installed_cert.stat.exists | default(false) }}"
  when: ca_cert_provided
  tags:
    - ssl-config
    - test

# Verify that the certificate actually works with HTTPS connections
- name: Test HTTPS connectivity with curl
  ansible.builtin.command: >
    curl -sI {{ ssl_test_url }}
  register: curl_https_test
  changed_when: false
  failed_when: curl_https_test.rc != 0
  when: 
    - ca_cert_provided is defined
    - ca_cert_provided | bool
    - ssl_test_connectivity | bool
  tags:
    - ssl-config
    - test
    - ssl-verify

- name: Test HTTPS connectivity with Python
  ansible.builtin.command: >
    python3 -c "import urllib.request; urllib.request.urlopen('{{ ssl_test_url }}').read(1)"
  register: python_https_test
  changed_when: false
  failed_when: python_https_test.rc != 0
  become: no
  when:
    - ca_cert_provided is defined
    - ca_cert_provided | bool
    - ssl_test_connectivity | bool
  tags:
    - ssl-config
    - test
    - ssl-verify

- name: Display HTTPS verification status
  ansible.builtin.debug:
    msg:
      - "✓ curl HTTPS test: Success"
      - "✓ Python HTTPS test: Success"
      - "✓ CA certificate is working correctly"
  when:
    - ca_cert_provided is defined
    - ca_cert_provided | bool
    - curl_https_test.rc is defined and curl_https_test.rc == 0
    - python_https_test.rc is defined and python_https_test.rc == 0
  tags:
    - ssl-config
    - test
    - ssl-verify
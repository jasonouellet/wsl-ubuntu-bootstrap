---
- name: Install Python packages (APT)
  ansible.builtin.apt:
    name: "{{ python_packages_apt }}"
    state: present
    update_cache: true
  tags:
    - python
    - packages

- name: Install Python CLI tools via pipx (root)
  ansible.builtin.shell: |
    export PATH="$PATH:$HOME/.local/bin"
    pipx install "{{ item }}" 2>&1
  loop: "{{ python_tools_pipx }}"
  environment:
    HOME: /root
  register: python_pipx_root_install
  changed_when: "item not in python_pipx_root_install.stdout"
  failed_when: false
  tags:
    - python
    - packages

- name: Install Python CLI tools via pipx (current user)
  ansible.builtin.shell: |
    export PATH="$PATH:$HOME/.local/bin"
    pipx install "{{ item }}" 2>&1
  loop: "{{ python_tools_pipx }}"
  become: false
  register: python_pipx_user_install
  changed_when: "item not in python_pipx_user_install.stdout"
  failed_when: false
  tags:
    - python
    - packages

- name: Ensure pipx path for current user
  ansible.builtin.command: pipx ensurepath --force
  become: false
  changed_when: false
  failed_when: false
  tags:
    - python
    - packages

- name: Get real user home directory from system facts
  ansible.builtin.shell:
    cmd: "getent passwd {{ ansible_facts['env']['USER'] }} | cut -d':' -f6"
  register: python_user_home_result
  become: false
  changed_when: false
  tags:
    - python
    - packages

- name: Set python real user home fact
  ansible.builtin.set_fact:
    python_real_user_home: "{{ python_user_home_result.stdout | trim }}"
  tags:
    - python
    - packages

- name: Add pipx to user PATH in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ python_real_user_home }}/.bashrc"
    line: 'export PATH="$HOME/.local/bin:$PATH"'
    create: true
    mode: '0644'
    owner: "{{ ansible_facts['env']['USER'] }}"
    state: present
  become: false
  tags:
    - python
    - packages

- name: Ensure pipx binaries are globally accessible
  ansible.builtin.command: pipx ensurepath --global
  environment:
    HOME: /root
  changed_when: false
  failed_when: false
  tags:
    - python
    - packages

- name: Add pipx to global PATH
  ansible.builtin.lineinfile:
    path: /etc/profile.d/pipx.sh
    line: 'export PATH="/root/.local/bin:$PATH"'
    create: true
    mode: '0644'
  tags:
    - python
    - packages

- name: Install Python packages (PIP in venv)
  ansible.builtin.pip:
    name: "{{ python_packages_pip }}"
    state: present
    virtualenv: /opt/python-venv
    virtualenv_command: python3 -m venv
  tags:
    - python
    - packages

- name: Verify Python installation
  ansible.builtin.command: python3 --version
  register: python_version
  changed_when: false
  tags:
    - python
    - test

- name: Verify pipx PATH configurations exist
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - /etc/profile.d/pipx.sh
    - "/home/{{ python_real_user_home }}/.bashrc"
  register: python_pipx_path_configs
  tags:
    - python
    - test

- name: Check for PATH duplicates in bashrc
  ansible.builtin.shell: |
    grep -c "\.local/bin" "/home/{{ python_real_user_home }}/.bashrc" || echo "0"
  register: python_path_count
  changed_when: false
  become: false
  tags:
    - python
    - test

- name: Verify pipx tools are accessible
  ansible.builtin.shell: |
    export PATH="$HOME/.local/bin:$PATH"
    which {{ item }}
  loop:
    - pre-commit
    - yamllint
    - pylint
    - black
  register: python_pipx_tools
  changed_when: false
  failed_when: false
  become: false
  tags:
    - python
    - test

- name: Display Python version
  ansible.builtin.debug:
    msg:
      - "Python version: {{ python_version.stdout }}"
      - "PATH entries in .bashrc: {{ python_path_count.stdout }}"
      - "pre-commit accessible: {{ python_pipx_tools.results[0].rc == 0 }}"
      - "yamllint accessible: {{ python_pipx_tools.results[1].rc == 0 }}"
      - "pylint accessible: {{ python_pipx_tools.results[2].rc == 0 }}"
      - "black accessible: {{ python_pipx_tools.results[3].rc == 0 }}"
  tags:
    - python
    - test
